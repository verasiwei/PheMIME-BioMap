---
title: "Phe-OmicsMIME Implementation"
author: "Siwei Zhang"
date: "2024-02-18"
output: html_document
resource_files:
- jak2_carrier_multimorbidity_regression_clean.rds
- phecode_def.rda
---

## JAK2-V617F

### JAK2-V617F carriers multimorbidity networks | JAK2-V617F non-carriers multimorbidity networks

- phecode_a ~ phecode_b+age+sex+age+race+EHRage

- phecode_b ~ phecode_a+age+sex+age+race+EHRage

### Cluster analysis for disease phenotypes that enriched in JAK2-V617F carriers (multimorbidity)

- Excluding disease pairs that significantly prevalent among JAK2-V617F non-carriers multimorbidity networks.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE}
### associationsubgraph
library(tidyverse)
# install.packages("/home/siwei/associationsubgraphs",repos=NULL, type="source")
library(associationsubgraphs,lib.loc = .libPaths()[2])
library(phewasHelper)
# load("phecode_def.rda")

results_clean = readRDS("jak2_carrier_multimorbidity_regression_clean.rds")
results_clean_non = readRDS("jak2_noncarrier_multimorbidity_regression_clean.rds")
n_code = length(unique(c(results_clean$a,results_clean$b)))
n_code_non = length(unique(c(results_clean_non$a,results_clean_non$b)))

phecode_pairs_non = results_clean_non %>%
  filter(p_val_a<0.05/n_code_non & p_val_b<0.05/n_code_non) %>%
  filter(overlap!=0) %>%
  filter(n_a>5) %>%
  filter(n_b>5) %>%
  dplyr::select(a,b,z_combined) %>%
  arrange(desc(z_combined)) %>%
  filter(!is.na(z_combined)) %>%
  dplyr::rename(strength = z_combined) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a))

phecode_pairs = results_clean %>%
  # filter(p_val_a<0.05/n_code & p_val_b<0.05/n_code)%>%
  filter(overlap!=0) %>%
  filter(n_a>5) %>%
  filter(n_b>5) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a)) %>%
  filter(!a_b %in% phecode_pairs_non$a_b) %>%
  filter(!a_b %in% phecode_pairs_non$b_a) %>%
  filter(!b_a %in% phecode_pairs_non$a_b) %>%
  filter(!b_a %in% phecode_pairs_non$b_a) %>%
  dplyr::select(a,b,z_combined) %>%
  arrange(desc(z_combined)) %>%
  filter(!is.na(z_combined)) %>%
  dplyr::rename(strength = z_combined)

# phecode_pairs = bind_rows(results_clean %>%
#   filter(overlap!=0) %>%
#   filter(n_a>5) %>%
#   filter(n_b>5) %>%
#   mutate(a_b=paste0(a,"_",b)) %>%
#   filter(p_val_a<0.05/n_code & p_val_b<0.05/n_code)
#   ,
#   results_clean %>%
#   filter(overlap!=0) %>%
#   filter(n_a>5) %>%
#   filter(n_b>5) %>%
#   mutate(a_b=paste0(a,"_",b)) %>%
#   filter(p_val_a>0.05/n_code & p_val_b>0.05/n_code) %>%
#   filter(!a_b %in% phecode_pairs_non$a_b)) %>%
#   dplyr::select(a,b,z_combined) %>%
#   arrange(desc(z_combined)) %>%
#   filter(!is.na(z_combined)) %>%
#   dplyr::rename(strength = z_combined)

#calculate subgraph structure
subgraphs <- phecode_pairs %>% 
  calculate_subgraph_structure()

annotate_node = c(phecode_pairs$a,phecode_pairs$b) %>%
  unique() %>%
  as_tibble() %>%
  dplyr::rename(id = value) %>% #rename the column corresponds to the variables to "id"
  left_join(.,phecode_def %>% dplyr::select(phecode,description,group,color) %>% dplyr::rename(id=phecode),by="id") %>% # add additional info
  arrange(group)
annotate_node = annotate_node %>%
  dplyr::select(-id) %>%
  dplyr::rename(id=description)

#convert Phecode to Phecode description
phecode_pairs = phecode_pairs %>%
  dplyr::rename(phecode=a) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(a=description) %>%
  dplyr::select(-phecode) %>%
  dplyr::rename(phecode=b) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(b=description) %>%
  dplyr::select(-phecode)

visualize_subgraph_structure(
  phecode_pairs,
  node_info = annotate_node,
  subgraph_results = subgraphs,
  trim_subgraph_results = TRUE
)


```


### CLuster analysis for disease phenotypes that enriched in JAK2-V617F carriers (similarity)

- Excluding disease pairs that prevalent among JAK2-V617F non-carriers multimorbidity similarity networks.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE}
phecode_similarities = readRDS("jak2_carrier_multimorbidity_similarity.rds") %>%
  dplyr::select(a,b,strength=sim) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a))

phecode_similarities_non = readRDS("jak2_noncarrier_multimorbidity_similarity.rds") %>%
  dplyr::select(a,b,strength=sim) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a))

phecode_similarities = phecode_similarities %>%
  filter(!a_b %in% phecode_similarities_non$a_b) %>%
  filter(!a_b %in% phecode_similarities_non$b_a) %>%
  filter(!b_a %in% phecode_similarities_non$a_b) %>%
  filter(!b_a %in% phecode_similarities_non$b_a)

#calculate subgraph structure
subgraphs <- phecode_similarities %>% 
  dplyr::select(a,b,strength) %>%
  calculate_subgraph_structure()

annotate_node = c(phecode_similarities$a,phecode_similarities$b) %>%
  unique() %>%
  as_tibble() %>%
  dplyr::rename(id = value) %>% #rename the column corresponds to the variables to "id"
  left_join(.,phecode_def %>% dplyr::select(phecode,description,group,color) %>% dplyr::rename(id=description),by="id") %>% # add additional info
  arrange(group)

visualize_subgraph_structure(
  phecode_similarities,
  node_info = annotate_node,
  subgraph_results = subgraphs,
  trim_subgraph_results = TRUE
)
```


### Story of the similarity network

#### Overall

- See the table below, overall there are 107 individuals with diagnosis of "Abnormality of red blood cells", 9 of them are JAK2 mutation carriers, but the fisher's exact show the significant results, it is true "abnormality of red blood cells" is enriched in JAK2 mutation carrier. 

- Increased risk of pregnancy complications in patients with essential thrombocythemia (ET) carrying the JAK2 v617f mutation and ET is a myeloproliferative disorder that can cause hypertension.

- These two phenotype clusters seems related to "ET" and "PV", which are disease subtypes of MPN?

- The strengths are all negative here and the p-values are not significant so the strengths here is not meaningful. But it can indicate that all these pregnancy complications co-occur with essential hypertension more often than expected, and these diseases phenotypes do not often co-occur with other diseases (diseases co-occur with abnormality of red blood cells) except essential hypertension, malaise and fatigue, pain in joint.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 12, fig.height = 12}
library(r2d3)
source("helpers_func.R")
# source("/home/siwei/paper_draft_prepare/omics_multimorbidity/modules/data_loading.R")
results_clean = readRDS("jak2_carrier_multimorbidity_regression_clean.rds")
# results_clean_non = readRDS("jak2_noncarrier_multimorbidity_regression_clean.rds")
phecode_pairs = results_clean %>%
  mutate(p_val = pmax(p_val_a,p_val_b)) %>%
  filter(overlap!=0) %>%
  filter(n_a>5) %>%
  filter(n_b>5) %>%
  dplyr::select(a,b,z_combined,p_val) %>%
  arrange(desc(z_combined)) %>%
  filter(!is.na(z_combined)) %>%
  dplyr::rename(strength = z_combined)
#convert Phecode to Phecode description
phecode_pairs = phecode_pairs %>%
  dplyr::rename(phecode=a) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(a=description) %>%
  dplyr::select(-phecode) %>%
  dplyr::rename(phecode=b) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(b=description) %>%
  dplyr::select(-phecode)

combined_associations = phecode_pairs
common_codes <- unique(c(combined_associations$a,combined_associations$b))
  
# Filter the associations to only ones involving codes present in all systems/combined
nested_associations <- combined_associations %>%
    filter(a %in% common_codes, b %in% common_codes) %>%
    dplyr::select(-contains("overlap")) %>% 
    rename_with(function(col_name){str_remove(col_name, "z_")}) %>% 
    mirror_a_b() %>% 
    # mutate(b = furrr::future_map_int(b, ~which(common_codes == .x))) %>%
    group_by(a) %>%
    nest() %>% 
    ungroup()
##add phecode group
nested_associations = nested_associations %>%
  left_join(.,phecode_def %>% dplyr::rename(a=description) %>% dplyr::select(a,group),by="a") %>%
  filter(a == "Abnormality of red blood cells" | group=="pregnancy complications")
phecode_to_associations <- set_names(nested_associations$data, nested_associations$a)

## heatmap to explore the overlap phecodes between pregnancy complications with abnormality of red blood cells
code_in_red_blood = nested_associations$data[[12]]$b
heatmap_dat = purrr::map_dfr(1:12, function(i){
  
  dat = nested_associations$data[[i]] %>%
    mutate(a =nested_associations$a[i]) %>%
    filter(b %in% code_in_red_blood) %>%
    mutate(p_val = round(p_val,2))
  dat
  
})
heatmap_dat$a = str_replace_all(heatmap_dat$a,", ","_")
heatmap_dat$b = str_replace_all(heatmap_dat$b,", ","_")

ggplot(heatmap_dat, aes(a, b, fill= strength)) + 
  geom_tile()+
  labs(x="Phenotypes in subgraph 1", 
              y="Diseases co-occur with abnormaility of red blood cells",
              title="Heatmap",
              subtitle="each cell filled with p-value")+
  geom_text(aes(label = p_val)) + 
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle = 30, hjust=1))
```


#### Overlap with JAK2 mutation

- Patients with "abnormality of red blood cells" diagnosis is enriched in JAK2 mutation carrier. 

- Patients with diagnosis of the phenotypic subgraphs 1 is enriched in JAK2 mutation. Fisher's exact test show the significant results.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 12, fig.height = 12}
### abnormality of red blood cells overlap with JAK2 mutation
jak2_dat = readRDS("intensity_JAK2_92k.rds")
phe_dat_long = readRDS("mega_phe_dat_long.rds")
phe_timeline_dat = readRDS("jak2_phe_timline_dat.rds")
demo_dat = readRDS("jak2_demo_dat.rds")
subset = phe_dat_long %>% 
  filter(phecode %in% c("289.90")) %>%
  filter(grid %in% jak2_dat$grid) %>%
  distinct(grid,.keep_all = T) 
jak2_dat = jak2_dat %>%
  mutate(abnormal_redbloodcell=ifelse(grid %in% subset$grid[subset$phecode %in% "289.90"],"abnormal","normal"),
         essential_hypertension=ifelse(grid %in% subset$grid[subset$phecode %in% "401.10"],"hypertension","no_hypertension"))
knitr::kable(table(jak2_dat$abnormal_redbloodcell,jak2_dat$group))
fisher.test(table(jak2_dat$abnormal_redbloodcell,jak2_dat$group))

nodes_subgraph = read_delim("nodes_data_subgraph1.csv",delim = ",") %>%
  left_join(.,phecode_def %>% dplyr::select(phecode,id=description),by="id")
subset_subgraph = phe_dat_long %>%
  filter(phecode %in% nodes_subgraph$phecode) %>%
  dplyr::select(grid) %>%
  distinct(grid,.keep_all = T)
jak2_dat = jak2_dat %>%
  mutate(subtype1 = ifelse(grid %in% subset_subgraph$grid,"subtype1","not subtype1"))
knitr::kable(table(jak2_dat$subtype1,jak2_dat$group))
fisher.test(table(jak2_dat$subtype1,jak2_dat$group))

# ## boxplot of BAF for patients with abnormality of red blood cell
# ggplot(jak2_dat, aes(y=x..x.y., x=abnormal_redbloodcell)) + 
#   geom_boxplot()
```

#### Age at diagnosis

- Distribution of diagnosis date for patients with diagnosis of phenotypic subgraph1 vs Distribution of diagnosis date for patients with diagnosis of phenotypic subgraph2.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 8, fig.height = 8}
# phe_timeline_dat = phe_timeline_dat %>%
#   filter(grid %in% jak2_dat$grid)
# saveRDS(phe_timeline_dat, file = "jak2_phe_timline_dat.rds")
# phe_timeline_dat = readRDS("jak2_phe_timline_dat.rds")
# demo_dat = readRDS("jak2_demo_dat.rds")
library(eeptools)

phe_timeline_dat_subgraph1 = phe_timeline_dat %>%
  filter(phecode %in% nodes_subgraph$phecode) %>%
  group_by(grid,phecode) %>%
  arrange(time) %>%
  mutate(min_date = min(time)) %>%
  ungroup() %>%
  filter(time == min_date)

nodes_subgraph2 = read_delim("nodes_data_subgraph2.csv",delim = ",") %>%
  left_join(.,phecode_def %>% dplyr::select(phecode,id=description),by="id")
phe_timeline_dat_subgraph2 = phe_timeline_dat %>%
  filter(phecode %in% nodes_subgraph2$phecode) %>%
  group_by(grid,phecode) %>%
  arrange(time) %>%
  mutate(min_date = min(time)) %>%
  ungroup() %>%
  filter(time == min_date)

phe_timeline_dat_subgraph = bind_rows(phe_timeline_dat_subgraph1 %>% mutate(group="subgraph1"),
                                      phe_timeline_dat_subgraph2 %>% mutate(group="subgraph2")) %>%
  left_join(demo_dat, by="grid") %>%
  # filter(as.Date(time) > as.Date(DOB)) %>%
  mutate(diag_age = as.numeric(difftime(as.Date(time),as.Date(DOB),units = "days")/365))


ggplot(phe_timeline_dat_subgraph, aes(x=diag_age, color = group)) + 
  geom_histogram(fill="white") + 
  labs(x="Age at diagnosis", 
              y="Count",
              title="Distribution of diagnosis age for subgraph1 vs subgraph2")+
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle = 30, hjust=1))


ggplot(phe_timeline_dat_subgraph %>% filter(phecode %in% "289.90" | group =="subgraph2")%>% mutate(group=ifelse(group=="subgraph2","subgraph2","abnormality of red blood cells")), 
       aes(x=diag_age, color = group)) + 
  geom_histogram(fill="white") + 
  labs(x="Age at diagnosis", 
              y="Count",
              title="Distribution of diagnosis age for patients with 'abonrmality of red blood cells vs patients with diagnosis of subgraph2")+
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle = 30, hjust=1))

pregnancy = phecode_def$phecode[phecode_def$description %in% nested_associations$a[1:11]]
  
ggplot(phe_timeline_dat_subgraph %>% filter(phecode %in% pregnancy | group =="subgraph2") %>% mutate(group=ifelse(group=="subgraph2","subgraph2","pregnancy complications")), 
       aes(x=diag_age, color = group)) + 
  geom_histogram(fill="white") + 
  labs(x="Age at diagnosis", 
              y="Count",
              title="Distribution of diagnosis age for patients with pregnancy complications vs patients with diagnosis of subgraph2")+
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle = 30, hjust=1))

```

#### Biological mechanisms

- Please use the "Phe-Omics" tool to explore

```{r,echo=FALSE, eval = F, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 8, fig.height = 8}
tidy_connect = readRDS("all_res_vumc_original_p_0.05.rds")
conn_nodes_subgraph1 = purrr::map(str_split(nodes_subgraph$id[-15],","),function(x){
      conn_first = tidy_connect %>%
        filter(institution == "vumc") %>%
        filter(from %in% x) %>%
        dplyr::select(node = to) %>%
        bind_rows(tidy_connect %>%
                    filter(institution == "vumc") %>%
                    filter(to %in% x) %>%
                    dplyr::select(node = from)) %>%
        distinct(node) %>%
        pull(node)
      conn_first
    })
shared_nodes_first = data.frame(ID=Reduce(intersect,conn_nodes_subgraph1)) 

```


- Shared biological mechanisms between "Abnormality of red blood cells" and "Pregnancy complications": 

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 12, fig.height = 12}
### biological analysis
# current_institution = "vumc"
# conn_nodes = purrr::map_dfr(str_split(unique(heatmap_dat$a),","),function(x){
#         conn_first = tidy_connect %>%
#           filter(institution == current_institution) %>%
#           filter(from %in% x) %>%
#           dplyr::select(node = to,hazard_ratio) %>%
#           bind_rows(tidy_connect %>%
#                       filter(institution == current_institution) %>%
#                       filter(to %in% x) %>%
#                       dplyr::select(node = from,hazard_ratio)) %>%
#           distinct(node,.keep_all = T) %>%
#           mutate(phenotype = x)
#       })
# 
# dat = conn_nodes %>%
#         left_join(.,all_id %>% dplyr::rename(node = variable) %>% dplyr::select(node,orig_id) %>% filter(!is.na(node)) %>%
#                     distinct(node,.keep_all = T), by="node") %>%
#         left_join(.,nodes %>% filter(institution==current_institution),by="node")
# dat = convert_id(dat)
# enrichment_res = enrichment_analysis(dat)
# saveRDS(enrichment_res,file = "jak2_carrier_similarity_pregnancy_blood_cells.rds")
enrichment_res = readRDS("jak2_carrier_similarity_pregnancy_blood_cells.rds")
r2d3(
      data=enrichment_res,
      script = "pathway_network.js",
      # dependencies = "inst/style.css",
      options = list(r2d3.theme = list(background="white")),
      container = "svg",
      d3_version = "5"
    )
library(kableExtra)
# knitr::kable(enrichment_res$res_table) %>%
#   kable_styling()

```

<!-- ### Story of the multimorbidity network -->

<!-- - Patients with diagnosis of the phenotypic subgraphs 1 is enriched in JAK2 mutation. Fisher's exact test show the significant results. -->

<!-- ```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE} -->
<!-- phe_dat_exclude_long = readRDS("jak2_phe_dat_exclude_long.rds") -->
<!-- nodes_subgraph = read_delim("nodes_data.csv",delim = ",") %>% -->
<!--   left_join(.,phecode_def %>% dplyr::select(phecode,id=description),by="id") -->
<!-- phe_dat_exclude_long_sub1 = phe_dat_exclude_long %>% -->
<!--   filter(phecode %in% nodes_subgraph$phecode) %>% -->
<!--   dplyr::select(grid) %>% -->
<!--   distinct(grid,.keep_all = T) -->
<!-- jak2_dat = readRDS(paste0("intensity_JAK2_92k.rds")) %>% -->
<!--   # dplyr::filter(group == "JAK2 V617F non-carrier") %>% -->
<!--   dplyr::select(grid,group) -->
<!-- phe_dat_exclude_long_sub1 = phe_dat_exclude_long_sub1 %>% -->
<!--   left_join(.,jak2_dat,by="grid") -->

<!-- compare_dat = data.frame("total" = c(91620, 789), "subtype" = c(47028, 480), row.names = c("non-carrier", "carrier")) -->
<!-- compare_dat -->
<!-- fisher.test(compare_dat) -->


<!-- ``` -->




### Clusters underlying biological mechanisms

- Basically, you could download the subgroup table for each disease cluster and upload the file into Phe-OmicsMIME to delve into the underlying biological mechanisms

- Here is the link to the Phe-OmicsMIME

[Phe-OmicsMIME](https://prod.tbilab.org/content/99395bec-6a59-4526-b1cf-e973e7746261){target="_blank"}










