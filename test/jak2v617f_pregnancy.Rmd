---
title: "JAK2v617f_pregnancy"
author: "Siwei Zhang"
date: "2024-04-05"
output: html_document
---

## JAK2-V617F carriers/non-carriers multimorbidity networks

```{r,echo=TRUE, cache=FALSE, warning=FALSE,message=FALSE}
library(tidyverse)
jak2_dat = readRDS(paste0("/proj/PI_SAVONA/Projects/CHIP_PheWAS/.common/data/92k/","intensity_JAK2_92k.rds")) %>%
  # dplyr::filter(group == "JAK2 V617F carrier") %>%
  dplyr::select(grid)

## build multimorbidity network
#================================prepare data for regression=============================#
# library(PheGenHelper)
library(phewasHelper)
library(future)
library(tidyverse)
##phenotype files
initiate_database(phe=T,phe_exclude = T, demo = T, phe_timeline = T)
extract_grid(phe=T, phe_exclude = T,demo_dat, jak2_dat)
phe_dat_exclude = phe_dat_exclude[phe_dat_exclude@Dimnames[[1]] %in% demo_dat$grid,]
demo_dat = demo_dat[demo_dat$grid %in% phe_dat_exclude@Dimnames[[1]],]

phe_dat_exclude_long = wide_to_long(phe_dat_exclude,type="phecode") %>%
  mutate(phecode = substring(phecode, 2, length(phecode))) %>%
  mutate(phecode = normalize_phecodes(phecode)) %>%
  arrange(grid)
saveRDS(phe_dat_exclude_long, file = "mega_phe_dat_long.rds")
write.table(phe_dat_exclude_long,file = "jak2_carriers_phe_dat_long.csv",col.names = T,row.names = F,sep = ",",quote = F)

##nested phenotype file: each row of phecode with index of patients who have this phecode
phecode_nested = phe_dat_exclude_long %>%
            arrange(grid) %>%
            group_by(grid) %>%
            mutate(int_id = cur_group_id()) %>%
            ungroup() %>%
            dplyr::select(-grid) %>%
            group_by(phecode) %>%
            nest()

options(future.globals.maxSize = 4000 * 1024 ^ 2)

expand_combinations <- function(n, repeats = FALSE){

  rep_counts <- n:1

  if(!repeats){
    rep_counts <- rep_counts - 1
  }

  tibble(
    a_index = rep(1:n, times = rep_counts),
    b_index = purrr::flatten_int( purrr::map(rep_counts, ~{tail(1:n, .x)}) )
  )
}

shuffle_df <- function(df){
  df[sample(1:nrow(df)),]
}

set.seed(777)
phecode_combos <- expand_combinations(nrow(phecode_nested)) %>%
  shuffle_df() 

id_to_demographics = demo_dat %>%
  arrange(grid) %>%
  mutate(age = ifelse(isDead==0,(as.Date(Sys.Date())-as.Date(DOB))/365,(as.Date(DOD)-as.Date(DOB))/365)) %>%
  dplyr::select(grid, age, EHRAge,SEX,RACE)
#================================run regression=============================#
start = Sys.time()
plan(multisession,workers = 30)
results <- furrr::future_pmap(
                   list(phecode_nested$data[phecode_combos$a_index],
                   phecode_nested$data[phecode_combos$b_index],
                   phecode_nested$phecode[phecode_combos$a_index],
                   phecode_nested$phecode[phecode_combos$b_index]),
                  #  .options = furrr_options(globals = c("id_to_demographics")),
                   purrr::safely(function(phecode_a_ids, phecode_b_ids,phecode_a,phecode_b) {

                    id_to_demographics$phecode_a <- 0L
                    id_to_demographics$phecode_a[phecode_a_ids$int_id] <- 1L
                     
                    id_to_demographics$phecode_b <- 0L
                    id_to_demographics$phecode_b[phecode_b_ids$int_id] <- 1L
                    
                        
                    a_to_b <-
                       speedglm::speedglm(
                         phecode_b ~ phecode_a + age + SEX + RACE + EHRAge,
                         family = binomial(),
                         data = id_to_demographics
                       )

                    b_to_a <-
                       speedglm::speedglm(
                         phecode_a ~ phecode_b + age + SEX + RACE + EHRAge,
                         family = binomial(),
                         data = id_to_demographics
                       )

                      bind_cols(phecode_a=phecode_a,phecode_b=phecode_b,dplyr::bind_cols(
                       dplyr::select(
                         broom::tidy(a_to_b)[2,],
                         beta_a = estimate,
                         std_err_a = std.error,
                         z_a = statistic,
                         p_val_a = p.value
                       ),
                       dplyr::select(
                         broom::tidy(b_to_a)[2,],
                         beta_b = estimate,
                         std_err_b = std.error,
                         z_b = statistic,
                         p_val_b = p.value
                       )
                     ) %>%
                       dplyr::mutate_if(is.factor, function(x){as.numeric(as.character(x))}) %>%
                       dplyr::mutate(
                         n_a = nrow(phecode_a_ids),
                         n_b = nrow(phecode_b_ids),
                         overlap = sum(id_to_demographics$phecode_a == 1 & id_to_demographics$phecode_b == 1)
                       ))
                   })
                   )
message("finish")
write_rds(results, "jak2_noncarrier_multimorbidity_regression.rds")
end = Sys.time()
end-start

#================================clean regression results=============================#
normalize_codes_and_avg_z <- . %>% 
  filter(!is.na(z1), 
         !is.na(z2)) %>% 
  mutate(Phecode1 = normalize_phecodes(Phecode1),
         Phecode2 = normalize_phecodes(Phecode2),
         z_avg = z1,
         code1_count = overlap / pct1 ,
         code2_count = overlap / pct2)

results = readRDS("jak2_noncarrier_multimorbidity_regression.rds")
results_clean = results %>%
  map_dfr('result') %>% 
  dplyr::rename(
      a = phecode_a,
      b = phecode_b
    ) %>%
  mutate(z_combined = (z_a*n_a+z_b*n_b)/(n_a+n_b),
         z_averaged = (z_a+z_b)/2)
```

## JAK2-V617F

- We built multimorbidity network for JAK2v617f mutation carriers and non carriers, respectively. Both the multimorbidity network utilized the below approach.
  
  phecode_a ~ phecode_b+age+sex+age+race+EHRage

  phecode_b ~ phecode_a+age+sex+age+race+EHRage

### Disease phenotypes that enriched in JAK2-V617F carriers

- We excluded disease pairs that significantly prevalent among JAK2-V617F non-carriers multimorbidity networks.

- The below shows the clusters of disease phenotypes that enriched in JAK2-v617f carriers multimorbidity networks.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE}
### associationsubgraph
library(tidyverse)
library(glue)
# install.packages("/home/siwei/associationsubgraphs",repos=NULL, type="source")
library(associationsubgraphs,lib.loc = .libPaths()[2])
library(phewasHelper)
# load("phecode_def.rda")

results_clean = readRDS("jak2_carrier_multimorbidity_regression_clean.rds")
results_clean_non = readRDS("jak2_noncarrier_multimorbidity_regression_clean.rds")
n_code = length(unique(c(results_clean$a,results_clean$b)))
n_code_non = length(unique(c(results_clean_non$a,results_clean_non$b)))

phecode_pairs_non = results_clean_non %>%
  filter(p_val_a<0.05/n_code_non & p_val_b<0.05/n_code_non) %>%
  filter(overlap!=0) %>%
  filter(n_a>5) %>%
  filter(n_b>5) %>%
  dplyr::select(a,b,z_combined) %>%
  arrange(desc(z_combined)) %>%
  filter(!is.na(z_combined)) %>%
  dplyr::rename(strength = z_combined) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a))

phecode_pairs = results_clean %>%
  # filter(p_val_a<0.05/n_code & p_val_b<0.05/n_code)%>%
  filter(overlap!=0) %>%
  filter(n_a>5) %>%
  filter(n_b>5) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a)) %>%
  filter(!a_b %in% phecode_pairs_non$a_b) %>%
  filter(!a_b %in% phecode_pairs_non$b_a) %>%
  filter(!b_a %in% phecode_pairs_non$a_b) %>%
  filter(!b_a %in% phecode_pairs_non$b_a) %>%
  dplyr::select(a,b,z_combined) %>%
  arrange(desc(z_combined)) %>%
  filter(!is.na(z_combined)) %>%
  dplyr::rename(strength = z_combined)

# phecode_pairs = bind_rows(results_clean %>%
#   filter(overlap!=0) %>%
#   filter(n_a>5) %>%
#   filter(n_b>5) %>%
#   mutate(a_b=paste0(a,"_",b)) %>%
#   filter(p_val_a<0.05/n_code & p_val_b<0.05/n_code)
#   ,
#   results_clean %>%
#   filter(overlap!=0) %>%
#   filter(n_a>5) %>%
#   filter(n_b>5) %>%
#   mutate(a_b=paste0(a,"_",b)) %>%
#   filter(p_val_a>0.05/n_code & p_val_b>0.05/n_code) %>%
#   filter(!a_b %in% phecode_pairs_non$a_b)) %>%
#   dplyr::select(a,b,z_combined) %>%
#   arrange(desc(z_combined)) %>%
#   filter(!is.na(z_combined)) %>%
#   dplyr::rename(strength = z_combined)

#calculate subgraph structure
subgraphs <- phecode_pairs %>% 
  calculate_subgraph_structure()

annotate_node = c(phecode_pairs$a,phecode_pairs$b) %>%
  unique() %>%
  as_tibble() %>%
  dplyr::rename(id = value) %>% #rename the column corresponds to the variables to "id"
  left_join(.,phecode_def %>% dplyr::select(phecode,description,group,color) %>% dplyr::rename(id=phecode),by="id") %>% # add additional info
  arrange(group)
annotate_node = annotate_node %>%
  dplyr::select(-id) %>%
  dplyr::rename(id=description)

#convert Phecode to Phecode description
phecode_pairs = phecode_pairs %>%
  dplyr::rename(phecode=a) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(a=description) %>%
  dplyr::select(-phecode) %>%
  dplyr::rename(phecode=b) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(b=description) %>%
  dplyr::select(-phecode)

multimorbidity_network = list(phecode_pairs,annotate_node,subgraphs)
saveRDS(multimorbidity_network,file="multimorbidity_network.rds")

visualize_subgraph_structure(
  phecode_pairs,
  node_info = annotate_node,
  subgraph_results = subgraphs,
  trim_subgraph_results = TRUE
)


```

### Disease phenotypes that enriched in JAK2-V617F carriers multimorbidity similarity network

- Multimorbidity similarity network demonstrates **Structure equivalence**, to see whether multimorbidity pattern having a high correlation between each pair of phenotypes.

- We excluded disease pairs that prevalent among JAK2-V617F non-carriers multimorbidity similarity networks.

- The below shows the clusters of disease phenotypes that enriched in JAK2-v617f carriers multimorbidity similarity networks.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE}
phecode_similarities = readRDS("jak2_carrier_multimorbidity_similarity.rds") %>%
  dplyr::select(a,b,strength=sim) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a))

phecode_similarities_non = readRDS("jak2_noncarrier_multimorbidity_similarity.rds") %>%
  dplyr::select(a,b,strength=sim) %>%
  mutate(a_b=paste0(a,"_",b)) %>%
  mutate(b_a=paste0(b,"_",a))

phecode_similarities = phecode_similarities %>%
  filter(!a_b %in% phecode_similarities_non$a_b) %>%
  filter(!a_b %in% phecode_similarities_non$b_a) %>%
  filter(!b_a %in% phecode_similarities_non$a_b) %>%
  filter(!b_a %in% phecode_similarities_non$b_a)

#calculate subgraph structure
subgraphs <- phecode_similarities %>% 
  dplyr::select(a,b,strength) %>%
  calculate_subgraph_structure()

annotate_node = c(phecode_similarities$a,phecode_similarities$b) %>%
  unique() %>%
  as_tibble() %>%
  dplyr::rename(id = value) %>% #rename the column corresponds to the variables to "id"
  left_join(.,phecode_def %>% dplyr::select(phecode,description,group,color) %>% dplyr::rename(id=description),by="id") %>% # add additional info
  arrange(group)

similarity_network = list(phecode_similarities,annotate_node,subgraphs)
saveRDS(similarity_network, file="similarity_network.rds")

visualize_subgraph_structure(
  phecode_similarities,
  node_info = annotate_node,
  subgraph_results = subgraphs,
  trim_subgraph_results = TRUE
)
```

### CONCOR approach on identifying multimorbidity profiles 
```{r,eval=FALSE,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE}
library(igraph)
jak2_dat = readRDS("intensity_JAK2_92k.rds")
phe_dat_long = readRDS("jak2_phe_dat_exclude_long.rds")
phe_timeline_dat = readRDS("jak2_phe_timline_dat.rds")
demo_dat = readRDS("jak2_demo_dat.rds")

## concor for jak2 mutation carriers, clustered only on phenotypes
#convert bipartite network to one-mode network, adjacency matrix for phenotypes with element of the number of patients two codes overlapped
#carriers
g = graph.data.frame(phe_dat_long %>% filter(grid %in% jak2_dat$grid[jak2_dat$group=="JAK2 V617F carrier"]), directed = F)
V(g)$type <- bipartite.mapping(g)$type
g_phe = bipartite.projection(g)
adj_phe = as.matrix(g_phe[[2]][])
#remove phenotype that does not actually co-occur with any other phenotypes
adj_phe = adj_phe[, colSums(abs(adj_phe)) > 0]
adj_phe = adj_phe[rowSums(abs(adj_phe)) > 0,]

#bipartite version
g = graph.data.frame(phe_dat_long %>% filter(grid %in% jak2_dat$grid[jak2_dat$group=="JAK2 V617F carrier"]), directed = F)
adj_matrix = as.matrix(as_adjacency_matrix(g))
n_samples = length(unique(phe_dat_long %>% filter(grid %in% jak2_dat$grid[jak2_dat$group=="JAK2 V617F carrier"]) %>% pull(grid)))
adj_phe = adj_matrix[1:n_samples,(n_samples+1):nrow(adj_matrix)]
adj_grid = adj_matrix[(n_samples+1):nrow(adj_matrix),1:n_samples]

# non-carriers
g = graph.data.frame(phe_dat_long %>% filter(grid %in% jak2_dat$grid[jak2_dat$group=="JAK2 V617F non-carrier"]), directed = F)
g_phe = bipartite.projection(g) ## spend much time and memory
adj_phe = as.matrix(g_phe[[2]][])
#remove phenotype that does not actually co-occur with any other phenotypes
adj_phe = adj_phe[, colSums(abs(adj_phe)) > 0]
adj_phe = adj_phe[rowSums(abs(adj_phe)) > 0,]
saveRDS(adj_phe,file="adj_phe_JAK2_noncarriers.rds")
adj_phe = readRDS("adj_phe_JAK2_noncarriers.rds")
# # non-carriers(save time) count the number of mutual patients between every pair of phecodes
# 
# adj_matrix = as.matrix(as_adjacency_matrix(g))
# adj_matrix= adj_matrix[1:n_samples,(n_samples+1):nrow(adj_matrix)]

### need to specify the number of clusters in prior
start = Sys.time()
concor_res = concor_split(adj_grid, cutoff = 0.999, max.iter = 25, p = 3)
end = Sys.time()
end-start
saveRDS(concor_res, file = "concor_res_bipartite_grid_JAK2_carriers.rds")

```

- Build the phenotype adjacency matrix with each element represents the number of overlapped individuals between each pair of phenotypes

- CONCOR cluster on the phenotypes 

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 10, fig.height = 10}
library(igraph)
jak2_dat = readRDS("intensity_JAK2_92k.rds")
phe_dat_long = readRDS("jak2_phe_dat_exclude_long.rds")
phe_timeline_dat = readRDS("jak2_phe_timline_dat.rds")
demo_dat = readRDS("jak2_demo_dat.rds")

concor_res_carrier = readRDS("concor_res_JAK2_carriers.rds")
concor_res_noncarrier = readRDS("concor_res_JAK2_noncarriers.rds")
concor_res_bipartite_phe_carrier = readRDS("concor_res_bipartite_phe_JAK2_carriers.rds")
concor_res_bipartite_grid_carrier = readRDS("concor_res_bipartite_grid_JAK2_carriers.rds")

# ## heatmap for the CONCOR bipartite cluster
# heatmap_dat = concor_res_bipartite_phe_carrier %>%
#   left_join(.,phe_dat_long %>% 
#               filter(grid %in% jak2_dat$grid[jak2_dat$group=="JAK2 V617F carrier"]) %>% 
#               rename(node=phecode),by="node") %>%
#   left_join(.,concor_res_bipartite_grid_carrier %>% rename(grid=node,block_grid=block),by="grid") %>%
#   arrange(block,block_grid) %>%
#   group_by(block,block_grid) %>%
#   distinct(grid,.keep_all = T) %>%
#   mutate(freq = n()) %>%
#   mutate(block = paste0("phenotype cluster",block)) %>%
#   mutate(block = factor(block,levels = paste0("phenotype cluster",1:32))) %>%
#   mutate(block_grid = paste0("patient cluster",block_grid)) %>%
#   mutate(block_grid = factor(block_grid,levels = paste0("patient cluster",1:32))) %>%
#   dplyr::select(-grid,-node) %>%
#   distinct(.,.keep_all = T)
#   
#  ggplot(heatmap_dat, aes(block, block_grid, fill= freq)) + 
#   geom_tile()+
#   scale_fill_distiller(palette = "Blues", direction = 1) +
#   geom_text(aes(label = round(freq,2))) + 
#   labs(x="Phecode group", 
#               y=glue("CONCOR clusters on "),
#               title=glue("CONCOR clusters on  vs Phecode categories"),
#               subtitle = "Each cell is filled with the number of overlapped phenotypes between CONCOR clusters and phecode categories")+
#   theme(axis.text=element_text(size=10),
#         axis.title=element_text(size=10,face="bold"),
#         axis.text.x = element_text(angle = 30, hjust=1))

## heatmap for the CONCOR clusters vs the phecode category
heatmap_func <- function(dat,group) {
  n_samples = length(unique(phe_dat_long %>% filter(grid %in% jak2_dat$grid[jak2_dat$group==group]) %>% pull(grid)))
  
  heatmap_dat = dat %>%
  left_join(.,phecode_def %>% rename(node=phecode) %>% dplyr::select(node,description,group,color)) %>%
  arrange(block,group) %>%
  group_by(block, group) %>%
  mutate(freq = n()) %>%
  mutate(block = paste0("cluster",block)) %>%
  mutate(block = factor(block,levels = paste0("cluster",1:32))) %>%
  ungroup() %>%
  left_join(.,phe_dat_long %>% rename(node=phecode) %>% filter(grid %in% jak2_dat$grid[jak2_dat$group==group]),by="node") %>%
  group_by(block,group) %>%
  distinct(grid,.keep_all = T) %>%
  mutate(prob = n()/n_samples) %>%
  dplyr::select(-grid) %>%
  distinct(.,.keep_all = T)
  
  ggplot(heatmap_dat, aes(group, block, fill= freq)) + 
  geom_tile()+
  scale_fill_distiller(palette = "Blues", direction = 1) +
  geom_text(aes(label = round(freq,2))) + 
  labs(x="Phecode group", 
              y=glue("CONCOR clusters on {group}"),
              title=glue("CONCOR clusters on {group} vs Phecode categories"),
              subtitle = "Each cell is filled with the number of overlapped phenotypes between CONCOR clusters and phecode categories")+
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle = 30, hjust=1))
  
}
heatmap_func(concor_res_carrier,"JAK2 V617F carrier")
heatmap_func(concor_res_noncarrier,"JAK2 V617F non-carrier")

#   heatmap_dat = concor_res_carrier %>%
#     rename(block_carrier=block) %>%
#     mutate(block_carrier = paste0("carrier_cluster",block_carrier)) %>%
#     mutate(block_carrier = factor(block_carrier,levels = paste0("carrier_cluster",1:32))) %>%
#     left_join(.,concor_res_noncarrier %>% 
#                 rename(block_noncarrier=block) %>%
#                 mutate(block_noncarrier = paste0("noncarrier_cluster",block_noncarrier)) %>%
#     mutate(block_noncarrier = factor(block_noncarrier,levels = paste0("noncarrier_cluster",1:32))),by="node") %>%
#     arrange(block_carrier,block_noncarrier) %>%
#     group_by(block_carrier, block_noncarrier) %>%
#     mutate(freq = n()) %>%
#     ungroup()
#   
#   ggplot(heatmap_dat, aes(block_carrier, block_noncarrier, fill= freq)) + 
#   geom_tile()+
#   # scale_fill_distiller(palette = "Blues", direction = 1) +
#   geom_text(aes(label = round(freq,2))) + 
#   labs(x="CONCOR clusters on carriers", 
#               y=glue("CONCOR clusters on noncarriers"),
#               title=glue("CONCOR clusters"))+
#   theme(axis.text=element_text(size=10),
#         axis.title=element_text(size=10,face="bold"),
#         axis.text.x = element_text(angle = 30, hjust=1))
#   
# concor_res_carrier = concor_res_carrier %>% 
#   left_join(.,phecode_def %>% rename(node=phecode) %>% 
#               dplyr::select(node,description,group,color))

```


## Similarity network

- Starting with the 1st cluster: "abnormality of red blood cells" in the center surrounded by a bunch of pregnancy complications.

#### Overall

- See the table below, overall there are 107 individuals with diagnosis of "Abnormality of red blood cells", 9 of them are JAK2 mutation carriers, but the fisher's exact show the significant results, it is true **"abnormality of red blood cells" is enriched in JAK2 mutation carrier**. 

- Increased risk of pregnancy complications in patients with essential thrombocythemia (ET) carrying the JAK2 v617f mutation and ET is a myeloproliferative disorder that can cause hypertension.

- These two phenotype clusters seems related to "ET" and "PV", which are disease subtypes of MPN?

- The strengths are all negative here and the p-values are not significant so the strengths here is not meaningful. But it can indicate that all these pregnancy complications co-occur with essential hypertension more often than expected, and these diseases phenotypes do not often co-occur with other diseases (diseases co-occur with abnormality of red blood cells) except essential hypertension, malaise and fatigue, pain in joint.

#### Overlap between "abnormality of red blood cells" and JAK2v617f mutation

- Patients with "abnormality of red blood cells" diagnosis is enriched in JAK2 mutation carrier. 

- Patients with diagnosis of the phenotypic subgraphs 1 is enriched in JAK2 mutation. Fisher's exact test show the significant results.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 12, fig.height = 12}
### abnormality of red blood cells overlap with JAK2 mutation
jak2_dat = readRDS("intensity_JAK2_92k.rds")
phe_dat_long = readRDS("mega_phe_dat_long.rds")
phe_timeline_dat = readRDS("jak2_phe_timline_dat.rds")
demo_dat = readRDS("jak2_demo_dat.rds")
subset = phe_dat_long %>% 
  filter(phecode %in% c("289.90")) %>%
  filter(grid %in% jak2_dat$grid) %>%
  distinct(grid,.keep_all = T) 
jak2_dat = jak2_dat %>%
  mutate(abnormal_redbloodcell=ifelse(grid %in% subset$grid[subset$phecode %in% "289.90"],"abnormality of red blood cells","without abnormality of red blood cells"),
         essential_hypertension=ifelse(grid %in% subset$grid[subset$phecode %in% "401.10"],"hypertension","no_hypertension"))
knitr::kable(table(jak2_dat$abnormal_redbloodcell,jak2_dat$group))
fisher.test(table(jak2_dat$abnormal_redbloodcell,jak2_dat$group))

nodes_subgraph = read_delim("nodes_data_subgraph1.csv",delim = ",") %>%
  left_join(.,phecode_def %>% dplyr::select(phecode,id=description),by="id")
subset_subgraph = phe_dat_long %>%
  filter(phecode %in% nodes_subgraph$phecode) %>%
  dplyr::select(grid) %>%
  distinct(grid,.keep_all = T)
jak2_dat = jak2_dat %>%
  mutate(subtype1 = ifelse(grid %in% subset_subgraph$grid,"subtype1","not subtype1"))
knitr::kable(table(jak2_dat$subtype1,jak2_dat$group))
fisher.test(table(jak2_dat$subtype1,jak2_dat$group))

# ## boxplot of BAF for patients with abnormality of red blood cell
# ggplot(jak2_dat, aes(y=x..x.y., x=abnormal_redbloodcell)) + 
#   geom_boxplot()
```

#### Why "abnormality of red blood cells" and "pregnancy complications forms into cluster?

- Pregnancy complication and abnormality of red blood cells might share common connected phenotypes? Multimorbidity strength within the connection between "Phenotypes related to Abnormality of red blood cells" and "pregnancy complications". Increased risk of pregnancy complications in patients with essential thrombocythemia (ET) carrying the JAK2 v617f mutation and ET is a myeloproliferative disorder that can cause hypertension.

- The strengths are all negative here and the p-values are not significant so the strengths here is not meaningful. But it can indicate that **all these pregnancy complications co-occur with essential hypertension more often than expected**, and these diseases phenotypes do not often co-occur with other diseases (diseases co-occur with abnormality of red blood cells) except **essential hypertension, malaise and fatigue, pain in joint**.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 12, fig.height = 12}
library(r2d3)
source("helpers_func.R")
# source("/home/siwei/paper_draft_prepare/omics_multimorbidity/modules/data_loading.R")
results_clean = readRDS("jak2_carrier_multimorbidity_regression_clean.rds")
# results_clean_non = readRDS("jak2_noncarrier_multimorbidity_regression_clean.rds")
phecode_pairs = results_clean %>%
  mutate(p_val = pmax(p_val_a,p_val_b)) %>%
  filter(overlap!=0) %>%
  filter(n_a>5) %>%
  filter(n_b>5) %>%
  dplyr::select(a,b,z_combined,p_val) %>%
  arrange(desc(z_combined)) %>%
  filter(!is.na(z_combined)) %>%
  dplyr::rename(strength = z_combined)
#convert Phecode to Phecode description
phecode_pairs = phecode_pairs %>%
  dplyr::rename(phecode=a) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(a=description) %>%
  dplyr::select(-phecode) %>%
  dplyr::rename(phecode=b) %>%
  left_join(.,phecode_def[,c("phecode","description")],by="phecode") %>%
  dplyr::rename(b=description) %>%
  dplyr::select(-phecode)

combined_associations = phecode_pairs
common_codes <- unique(c(combined_associations$a,combined_associations$b))
  
# Filter the associations to only ones involving codes present in all systems/combined
nested_associations <- combined_associations %>%
    filter(a %in% common_codes, b %in% common_codes) %>%
    dplyr::select(-contains("overlap")) %>% 
    rename_with(function(col_name){str_remove(col_name, "z_")}) %>% 
    mirror_a_b() %>% 
    # mutate(b = furrr::future_map_int(b, ~which(common_codes == .x))) %>%
    group_by(a) %>%
    nest() %>% 
    ungroup()
##add phecode group
nested_associations = nested_associations %>%
  left_join(.,phecode_def %>% dplyr::rename(a=description) %>% dplyr::select(a,group),by="a") %>%
  filter(a == "Abnormality of red blood cells" | group=="pregnancy complications")
phecode_to_associations <- set_names(nested_associations$data, nested_associations$a)

## heatmap to explore the overlap phecodes between pregnancy complications with abnormality of red blood cells
code_in_red_blood = nested_associations$data[[12]]$b
heatmap_dat = purrr::map_dfr(1:11, function(i){
  
  dat = nested_associations$data[[i]] %>%
    mutate(a =nested_associations$a[i]) %>%
    filter(b %in% code_in_red_blood) %>%
    mutate(p_val = round(p_val,2))
  dat
  
})
heatmap_dat$a = str_replace_all(heatmap_dat$a,", ","_")
heatmap_dat$b = str_replace_all(heatmap_dat$b,", ","_")
saveRDS(heatmap_dat,file="heatmap_dat.rds")

ggplot(heatmap_dat, aes(a, b, fill= strength)) + 
  geom_tile()+
  labs(x="Phenotypes in subgraph 1", 
              y="Diseases co-occur with abnormaility of red blood cells",
              title="Heatmap",
              subtitle="each cell filled with p-value")+
  geom_text(aes(label = p_val)) + 
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle = 30, hjust=1))
```

#### Further investigation on predictive factors of pregnancy complications

- Pregnant women having the symptoms that co-occur more often than expected (**essential hypertension, malaise and fatigue, pain in joint**) have a higher ratio of having complications.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 8, fig.height = 8}
## extract pregnant women
##phenotype files
# aws.s3::s3load("s3://bvehrdata/bv221/SD/GRID_ICD9.Aug2017.timelines.RData")
# icd9.tm = data.frame(icd9.tm)
# icd9codes = paste(as.character(c(630:679)), collapse = "|")
# dat_pregnancy = icd9.tm %>%
#   filter(str_detect(ICD9,icd9codes)) %>%
#   distinct(GRID,.keep_all = T)
# ## extract patients with symptoms of essential hypertension, malaise and fatigue, pain in joint
# phecode_tm = aws.s3::s3readRDS("s3://bvehrdata/bv221/SD/grid_phecode_Aug2017_timelines.rds")
# phecodes = paste(as.character(c(401.10,798.00,745.00)), collapse = "|")
# dat_symptom = phecode_tm %>%
#   filter(str_detect(phecode, phecodes)) %>%
#   distinct(grid,.keep_all = T) %>%
#   filter(grid %in% dat_pregnancy$GRID)
# ## extract patients with complications
# phecodes_complications =  paste(as.character(phecode_def$phecode[phecode_def$description %in% nested_associations$a[1:11]]), collapse = "|")
# dat_complications = phecode_tm %>%
#   filter(str_detect(phecode,phecodes_complications))%>%
#   distinct(grid,.keep_all = T) %>%
#   filter(grid %in% dat_pregnancy$GRID)
# 
# dat_pregnancy = dat_pregnancy %>%
#   mutate(symptoms = ifelse(GRID %in% dat_symptom$grid,"have symptoms","no symptoms")) %>%
#   mutate(complications = ifelse(GRID %in% dat_complications$grid,"have complications","no complications"))
# saveRDS(dat_pregnancy, file="dat_pregnancy.rds")
# saveRDS(dat_complications, file="dat_complications.rds")
# saveRDS(dat_symptom, file="dat_symptom.rds")

dat_pregnancy = readRDS("dat_pregnancy.rds")
jak2_dat = jak2_dat %>%
  mutate(pregnancy = ifelse(grid %in% unique(dat_pregnancy$GRID),"pregnant","not pregnant"))
dat_complications = readRDS("dat_complications.rds")
jak2_dat = jak2_dat %>%
  mutate(pregnancy_complications = ifelse(grid %in% unique(dat_complications$grid),"pregnancy complications","without pregnancy complications"))
dat_symptom = readRDS("dat_symptom.rds")
jak2_dat = jak2_dat %>%
  mutate(symptoms = ifelse(grid %in% unique(dat_symptom$grid),"have symptoms","without symptoms"))
knitr::kable(table(dat_pregnancy$symptoms,dat_pregnancy$complications))
fisher.test(table(dat_pregnancy$symptoms,dat_pregnancy$complications))
saveRDS(jak2_dat,"jak2_dat.rds")
```

#### Further investigation on "JAK2v617f mutation" and "Pregnancy complications"

- Does JAK2v617f mutation causes pregnancy complications directly Or does JAK2v617f mutations causes pregnancy complications indirectly? need time to think about this

- Within pregnant women, JAK2v167f carriers having significantly higher risk of pregnancy complications.

```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 8, fig.height = 8}
## 2*2 table of JAK2v617f and pregnancy complications within pregnant women
jak2_dat_pregnant = jak2_dat %>%
  filter(grid %in% dat_pregnancy$GRID) %>%
  mutate(complications = ifelse(grid %in% dat_complications$grid,"have complications","no complications"))
knitr::kable(table(jak2_dat_pregnant$group,jak2_dat_pregnant$complications))
fisher.test(table(jak2_dat_pregnant$group,jak2_dat_pregnant$complications))

```


<!-- #### Age at diagnosis -->

<!-- - Distribution of diagnosis date for patients with diagnosis of phenotypic subgraph1 vs Distribution of diagnosis date for patients with diagnosis of phenotypic subgraph2. -->

<!-- ```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 8, fig.height = 8} -->
<!-- # phe_timeline_dat = phe_timeline_dat %>% -->
<!-- #   filter(grid %in% jak2_dat$grid) -->
<!-- # saveRDS(phe_timeline_dat, file = "jak2_phe_timline_dat.rds") -->
<!-- # phe_timeline_dat = readRDS("jak2_phe_timline_dat.rds") -->
<!-- # demo_dat = readRDS("jak2_demo_dat.rds") -->
<!-- library(eeptools) -->

<!-- phe_timeline_dat_subgraph1 = phe_timeline_dat %>% -->
<!--   filter(phecode %in% nodes_subgraph$phecode) %>% -->
<!--   group_by(grid,phecode) %>% -->
<!--   arrange(time) %>% -->
<!--   mutate(min_date = min(time)) %>% -->
<!--   ungroup() %>% -->
<!--   filter(time == min_date) -->

<!-- nodes_subgraph2 = read_delim("nodes_data_subgraph2.csv",delim = ",") %>% -->
<!--   left_join(.,phecode_def %>% dplyr::select(phecode,id=description),by="id") -->
<!-- phe_timeline_dat_subgraph2 = phe_timeline_dat %>% -->
<!--   filter(phecode %in% nodes_subgraph2$phecode) %>% -->
<!--   group_by(grid,phecode) %>% -->
<!--   arrange(time) %>% -->
<!--   mutate(min_date = min(time)) %>% -->
<!--   ungroup() %>% -->
<!--   filter(time == min_date) -->

<!-- phe_timeline_dat_subgraph = bind_rows(phe_timeline_dat_subgraph1 %>% mutate(group="subgraph1"), -->
<!--                                       phe_timeline_dat_subgraph2 %>% mutate(group="subgraph2")) %>% -->
<!--   left_join(demo_dat, by="grid") %>% -->
<!--   # filter(as.Date(time) > as.Date(DOB)) %>% -->
<!--   mutate(diag_age = as.numeric(difftime(as.Date(time),as.Date(DOB),units = "days")/365)) -->


<!-- ggplot(phe_timeline_dat_subgraph, aes(x=diag_age, color = group)) +  -->
<!--   geom_histogram(fill="white") +  -->
<!--   labs(x="Age at diagnosis",  -->
<!--               y="Count", -->
<!--               title="Distribution of diagnosis age for subgraph1 vs subgraph2")+ -->
<!--   theme(axis.text=element_text(size=10), -->
<!--         axis.title=element_text(size=10,face="bold"), -->
<!--         axis.text.x = element_text(angle = 30, hjust=1)) -->


<!-- ggplot(phe_timeline_dat_subgraph %>% filter(phecode %in% "289.90" | group =="subgraph2")%>% mutate(group=ifelse(group=="subgraph2","subgraph2","abnormality of red blood cells")),  -->
<!--        aes(x=diag_age, color = group)) +  -->
<!--   geom_histogram(fill="white") +  -->
<!--   labs(x="Age at diagnosis",  -->
<!--               y="Count", -->
<!--               title="Distribution of diagnosis age for patients with 'abonrmality of red blood cells vs patients with diagnosis of subgraph2")+ -->
<!--   theme(axis.text=element_text(size=10), -->
<!--         axis.title=element_text(size=10,face="bold"), -->
<!--         axis.text.x = element_text(angle = 30, hjust=1)) -->

<!-- pregnancy = phecode_def$phecode[phecode_def$description %in% nested_associations$a[1:11]] -->

<!-- ggplot(phe_timeline_dat_subgraph %>% filter(phecode %in% pregnancy | group =="subgraph2") %>% mutate(group=ifelse(group=="subgraph2","subgraph2","pregnancy complications")),  -->
<!--        aes(x=diag_age, color = group)) +  -->
<!--   geom_histogram(fill="white") +  -->
<!--   labs(x="Age at diagnosis",  -->
<!--               y="Count", -->
<!--               title="Distribution of diagnosis age for patients with pregnancy complications vs patients with diagnosis of subgraph2")+ -->
<!--   theme(axis.text=element_text(size=10), -->
<!--         axis.title=element_text(size=10,face="bold"), -->
<!--         axis.text.x = element_text(angle = 30, hjust=1)) -->

<!-- ``` -->

<!-- #### Biological mechanisms -->

<!-- - Please use the "Phe-Omics" tool to explore -->

<!-- ```{r,echo=FALSE, eval = F, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 8, fig.height = 8} -->
<!-- tidy_connect = readRDS("all_res_vumc_original_p_0.05.rds") -->
<!-- conn_nodes_subgraph1 = purrr::map(str_split(nodes_subgraph$id[-15],","),function(x){ -->
<!--       conn_first = tidy_connect %>% -->
<!--         filter(institution == "vumc") %>% -->
<!--         filter(from %in% x) %>% -->
<!--         dplyr::select(node = to) %>% -->
<!--         bind_rows(tidy_connect %>% -->
<!--                     filter(institution == "vumc") %>% -->
<!--                     filter(to %in% x) %>% -->
<!--                     dplyr::select(node = from)) %>% -->
<!--         distinct(node) %>% -->
<!--         pull(node) -->
<!--       conn_first -->
<!--     }) -->
<!-- shared_nodes_first = data.frame(ID=Reduce(intersect,conn_nodes_subgraph1))  -->

<!-- ``` -->


<!-- - Shared biological mechanisms between "Abnormality of red blood cells" and "Pregnancy complications":  -->

<!-- ```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE,fig.width = 12, fig.height = 12} -->
<!-- ### biological analysis -->
<!-- # current_institution = "vumc" -->
<!-- # conn_nodes = purrr::map_dfr(str_split(unique(heatmap_dat$a),","),function(x){ -->
<!-- #         conn_first = tidy_connect %>% -->
<!-- #           filter(institution == current_institution) %>% -->
<!-- #           filter(from %in% x) %>% -->
<!-- #           dplyr::select(node = to,hazard_ratio) %>% -->
<!-- #           bind_rows(tidy_connect %>% -->
<!-- #                       filter(institution == current_institution) %>% -->
<!-- #                       filter(to %in% x) %>% -->
<!-- #                       dplyr::select(node = from,hazard_ratio)) %>% -->
<!-- #           distinct(node,.keep_all = T) %>% -->
<!-- #           mutate(phenotype = x) -->
<!-- #       }) -->
<!-- #  -->
<!-- # dat = conn_nodes %>% -->
<!-- #         left_join(.,all_id %>% dplyr::rename(node = variable) %>% dplyr::select(node,orig_id) %>% filter(!is.na(node)) %>% -->
<!-- #                     distinct(node,.keep_all = T), by="node") %>% -->
<!-- #         left_join(.,nodes %>% filter(institution==current_institution),by="node") -->
<!-- # dat = convert_id(dat) -->
<!-- # enrichment_res = enrichment_analysis(dat) -->
<!-- # saveRDS(enrichment_res,file = "jak2_carrier_similarity_pregnancy_blood_cells.rds") -->
<!-- enrichment_res = readRDS("jak2_carrier_similarity_pregnancy_blood_cells.rds") -->
<!-- r2d3( -->
<!--       data=enrichment_res, -->
<!--       script = "pathway_network.js", -->
<!--       # dependencies = "inst/style.css", -->
<!--       options = list(r2d3.theme = list(background="white")), -->
<!--       container = "svg", -->
<!--       d3_version = "5" -->
<!--     ) -->
<!-- library(kableExtra) -->
<!-- # knitr::kable(enrichment_res$res_table) %>% -->
<!-- #   kable_styling() -->

<!-- ``` -->

<!-- <!-- ### Story of the multimorbidity network --> -->

<!-- <!-- - Patients with diagnosis of the phenotypic subgraphs 1 is enriched in JAK2 mutation. Fisher's exact test show the significant results. --> -->

<!-- <!-- ```{r,echo=FALSE, cache=FALSE, warning=FALSE,message=FALSE} --> -->
<!-- <!-- phe_dat_exclude_long = readRDS("jak2_phe_dat_exclude_long.rds") --> -->
<!-- <!-- nodes_subgraph = read_delim("nodes_data.csv",delim = ",") %>% --> -->
<!-- <!--   left_join(.,phecode_def %>% dplyr::select(phecode,id=description),by="id") --> -->
<!-- <!-- phe_dat_exclude_long_sub1 = phe_dat_exclude_long %>% --> -->
<!-- <!--   filter(phecode %in% nodes_subgraph$phecode) %>% --> -->
<!-- <!--   dplyr::select(grid) %>% --> -->
<!-- <!--   distinct(grid,.keep_all = T) --> -->
<!-- <!-- jak2_dat = readRDS(paste0("intensity_JAK2_92k.rds")) %>% --> -->
<!-- <!--   # dplyr::filter(group == "JAK2 V617F non-carrier") %>% --> -->
<!-- <!--   dplyr::select(grid,group) --> -->
<!-- <!-- phe_dat_exclude_long_sub1 = phe_dat_exclude_long_sub1 %>% --> -->
<!-- <!--   left_join(.,jak2_dat,by="grid") --> -->

<!-- <!-- compare_dat = data.frame("total" = c(91620, 789), "subtype" = c(47028, 480), row.names = c("non-carrier", "carrier")) --> -->
<!-- <!-- compare_dat --> -->
<!-- <!-- fisher.test(compare_dat) --> -->


<!-- <!-- ``` --> -->




<!-- ### Clusters underlying biological mechanisms -->

<!-- - Basically, you could download the subgroup table for each disease cluster and upload the file into Phe-OmicsMIME to delve into the underlying biological mechanisms -->

<!-- - Here is the link to the Phe-OmicsMIME -->

<!-- [Phe-OmicsMIME](https://prod.tbilab.org/content/99395bec-6a59-4526-b1cf-e973e7746261){target="_blank"} -->










